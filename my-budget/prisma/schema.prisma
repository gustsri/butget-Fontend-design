generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. Enums (ตัวเลือกต่างๆ)
// ==========================================
enum DegreeLevel {
  bachelor
  bachelor_master
  master
  phd
}

enum ProgramType {
  normal
  international
}

enum PlanType {
  plan
  actual
}

enum BudgetStatus {
  draft
  submitted
  approved
  rejected
}

// ==========================================
// 2. ส่วนจัดการงบประมาณรายรับ (Revenue)
// ==========================================

// ตารางปีงบประมาณ (Header)
model RevenueBudget {
  revenue_budget_id Int          @id @default(autoincrement())
  budget_year       Int          @unique
  
  total_amount      Decimal      @default(0) @db.Decimal(15, 2)
  net_amount        Decimal      @default(0) @db.Decimal(15, 2)
  
  status            BudgetStatus @default(draft)
  version           Int          @default(1)
  
  is_active         Boolean      @default(true)
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt

  // Relations
  sections          RevenueSection[] 

  @@map("revenue_budgets")
}

// ตารางหมวดหมู่ (Section)
model RevenueSection {
  section_id        Int      @id @default(autoincrement())
  revenue_budget_id Int
  
  section_name      String
  sort_order        Int

  // Relation
  budget            RevenueBudget @relation(fields: [revenue_budget_id], references: [revenue_budget_id], onDelete: Cascade)
  items             RevenueItem[] 

  @@map("revenue_sections")
}

// ตารางรายการย่อย (Item)
model RevenueItem {
  item_id           Int      @id @default(autoincrement())
  section_id        Int
  
  item_name         String
  amount            Decimal  @default(0) @db.Decimal(15, 2)
  
  sort_order        Int
  is_deduction      Boolean  @default(false)
  
  // Relation
  section           RevenueSection @relation(fields: [section_id], references: [section_id], onDelete: Cascade)

  @@map("revenue_items")
}

// ==========================================
// 3. ส่วนข้อมูลการศึกษา (Academic & Enrollment)
// ==========================================

model AcademicProgram {
  academic_program_id Int         @id @default(autoincrement())
  program_name        String      @db.VarChar(255)
  degree_level        DegreeLevel
  program_type        ProgramType
  tuition_per_semester Decimal    @default(0) @db.Decimal(12, 2)

  is_active           Boolean     @default(true)
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  // Relations
  EnrollmentInformation EnrollmentInformation[]

  @@map("academic_programs") 
}

model EnrollmentInformation {
  enrollment_id       Int      @id @default(autoincrement())
  
  academic_program_id Int     
  academic_year       Int      
  semester            Int      
  
  plan_type           PlanType
  
  year1_count         Int      @default(0)
  year2_count         Int      @default(0)
  year3_count         Int      @default(0)
  year4_count         Int      @default(0)
  year5_count         Int      @default(0)
  year6_count         Int      @default(0)
  graduates           Int      @default(0) 

  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // Relations
  program             AcademicProgram @relation(fields: [academic_program_id], references: [academic_program_id])
  
  @@map("enrollment_information")
  @@unique([academic_program_id, academic_year, semester, plan_type])
}

// ---------------------------------------------------------
// รายจ่าย
// ---------------------------------------------------------

enum BudgetCategory {
  REVENUE
  EXPENSE
}

enum NodeType {
  PLAN      // Level 1
  JOB       // Level 2
  ACTIVITY  // Level 3 (จุดตัด)
  FUND      // Level 4
  CATEGORY  // หมวด
  ITEM      // รายการย่อย
}

enum InputType {
  HEADER     // โชว์เฉยๆ
  INPUT      // กรอกเงินได้
}

// ---------------------------------------------------------
// 2. REFERENCE DATA: โครงสร้างรหัสงบประมาณ (เปลี่ยนชื่อแล้ว)
// ---------------------------------------------------------
model StructureCode {
  id          Int            @id @default(autoincrement())
  code        String?        // รหัส (09007, 510101)
  name        String         // ชื่อรายการ
  
  category    BudgetCategory @default(EXPENSE)
  node_type   NodeType       
  input_type  InputType      @default(INPUT)
  
  level       Int            // 1, 2, 3...
  is_active   Boolean        @default(true)
  
  // Hierarchy (Self-Relation)
  parent_id   Int?
  parent      StructureCode?  @relation("StructureHierarchy", fields: [parent_id], references: [id])
  children    StructureCode[] @relation("StructureHierarchy")

  // Relation ไปยัง Transaction
  expense_items ExpenseItem[]

  @@index([code])
  @@index([category, is_active])
  @@map("structure_codes") // ชื่อตารางใน DB
}

// ---------------------------------------------------------
// 3. TRANSACTION DATA: ข้อมูลการของบจริง
// ---------------------------------------------------------
model ExpenseBudget {
  id              Int           @id @default(autoincrement())
  academic_year   Int
  
  total_gov       Decimal       @default(0) @db.Decimal(15, 2)
  total_income    Decimal       @default(0) @db.Decimal(15, 2)
  
  status          BudgetStatus  @default(draft)
  
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  items           ExpenseItem[]

  @@unique([academic_year])
  @@map("expense_budgets")
}

model ExpenseItem {
  id            Int           @id @default(autoincrement())
  
  budget_id     Int
  budget        ExpenseBudget @relation(fields: [budget_id], references: [id], onDelete: Cascade)

  // --- เปลี่ยนการเชื่อมโยงตรงนี้ ---
  structure_id  Int?
  structure     StructureCode? @relation(fields: [structure_id], references: [id])
  
  custom_name   String?       
  
  amount_gov    Decimal       @default(0) @db.Decimal(15, 2)
  amount_income Decimal       @default(0) @db.Decimal(15, 2)
  
  parent_id     Int?
  parent        ExpenseItem?  @relation("TransactionHierarchy", fields: [parent_id], references: [id])
  children      ExpenseItem[] @relation("TransactionHierarchy")

  description   String?       @db.Text

  @@index([budget_id])
  @@map("expense_items")
}