generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. Enums
// ==========================================
enum DegreeLevel {
  bachelor
  bachelor_master
  master
  phd
}

enum ProgramType {
  normal
  international
}

enum PlanType {
  plan
  actual
}

enum BudgetStatus {
  draft
  submitted
  approved
  rejected
}

// ==========================================
// 2. ส่วนจัดการงบประมาณรายรับ (Revenue)
// ==========================================
model RevenueBudget {
  revenue_budget_id Int          @id @default(autoincrement())
  budget_year       Int          @unique
  total_amount      Decimal      @default(0) @db.Decimal(15, 2)
  net_amount        Decimal      @default(0) @db.Decimal(15, 2)
  status            BudgetStatus @default(draft)
  version           Int          @default(1)
  is_active         Boolean      @default(true)
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt
  sections          RevenueSection[]

  @@map("revenue_budgets")
}

model RevenueSection {
  section_id        Int           @id @default(autoincrement())
  revenue_budget_id Int
  section_name      String
  sort_order        Int
  budget            RevenueBudget @relation(fields: [revenue_budget_id], references: [revenue_budget_id], onDelete: Cascade)
  items             RevenueItem[]

  @@map("revenue_sections")
}

model RevenueItem {
  item_id      Int            @id @default(autoincrement())
  section_id   Int
  item_name    String
  amount       Decimal        @default(0) @db.Decimal(15, 2)
  sort_order   Int
  is_deduction Boolean        @default(false)
  section      RevenueSection @relation(fields: [section_id], references: [section_id], onDelete: Cascade)

  @@map("revenue_items")
}

// ==========================================
// 3. ส่วนข้อมูลการศึกษา (Academic & Enrollment)
// ==========================================
model AcademicProgram {
  academic_program_id   Int                     @id @default(autoincrement())
  program_name          String                  @db.VarChar(255)
  degree_level          DegreeLevel
  program_type          ProgramType
  tuition_per_semester  Decimal                 @default(0) @db.Decimal(12, 2)
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt
  EnrollmentInformation EnrollmentInformation[]

  @@map("academic_programs")
}

model EnrollmentInformation {
  enrollment_id       Int             @id @default(autoincrement())
  academic_program_id Int
  academic_year       Int
  semester            Int
  plan_type           PlanType
  year1_count         Int             @default(0)
  year2_count         Int             @default(0)
  year3_count         Int             @default(0)
  year4_count         Int             @default(0)
  year5_count         Int             @default(0)
  year6_count         Int             @default(0)
  graduates           Int             @default(0)
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  program             AcademicProgram @relation(fields: [academic_program_id], references: [academic_program_id])

  @@unique([academic_program_id, academic_year, semester, plan_type])
  @@map("enrollment_information")
}

// =========================================================
// GROUP 1: โครงสร้างองค์กร (Organization Structure)
// =========================================================
model StrategicPlan {
  id        Int     @id @default(autoincrement())
  code      String?
  name      String
  level     Int
  is_active Boolean @default(true)

  parent_id Int?
  parent    StrategicPlan?  @relation("StratHierarchy", fields: [parent_id], references: [id])
  children  StrategicPlan[] @relation("StratHierarchy")

  activities ProjectActivity[]

  @@map("strategic_plans")
}

model ProjectActivity {
  id        Int     @id @default(autoincrement())
  code      String?
  name      String
  level     Int
  is_active Boolean @default(true)

  plan_id Int?
  plan    StrategicPlan? @relation(fields: [plan_id], references: [id])

  parent_id Int?
  parent    ProjectActivity?  @relation("ActHierarchy", fields: [parent_id], references: [id])
  children  ProjectActivity[] @relation("ActHierarchy")

  fund_allocations ActivityFundAllocation[]

  @@map("project_activities")
}

// =========================================================
// GROUP 2: Master Data ทางการเงิน (Financial Master Data)
// =========================================================
model FundMaster {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String

  allocations ActivityFundAllocation[]
  records     BudgetRecord[]

  @@map("fund_masters")
}

model BudgetCategory {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String

  items   ExpenseItemMaster[]
  records BudgetRecord[]

  @@map("budget_categories")
}

// ✅ แก้ไข: เพิ่ม parent_id และทำให้ code เป็น unique เพื่อรองรับ Seed
model ExpenseItemMaster {
  id   Int     @id @default(autoincrement())
  code String  @unique // จำเป็นต้องมี @unique เพื่อให้ค้นหาด้วย findUnique ได้
  name String

  category_id Int
  category    BudgetCategory @relation(fields: [category_id], references: [id])

  // เพิ่ม Self-Relation เพื่อทำ Hierarchy (Tree)
  parent_id Int?
  parent    ExpenseItemMaster?  @relation("ExpenseHierarchy", fields: [parent_id], references: [id])
  children  ExpenseItemMaster[] @relation("ExpenseHierarchy")

  form_type String         @default("simple")
  records   BudgetRecord[]

  @@map("expense_item_masters")
}

// =========================================================
// GROUP 3: การจับคู่และบันทึกข้อมูล (Transactions)
// =========================================================
model ActivityFundAllocation {
  id Int @id @default(autoincrement())

  activity_id Int
  activity    ProjectActivity @relation(fields: [activity_id], references: [id])

  fund_id Int
  fund    FundMaster @relation(fields: [fund_id], references: [id])

  budget_records BudgetRecord[]

  @@unique([activity_id, fund_id])
  @@map("activity_fund_allocations")
}

model BudgetRecord {
  id            Int @id @default(autoincrement())
  academic_year Int

  allocation_id Int
  allocation    ActivityFundAllocation @relation(fields: [allocation_id], references: [id])

  item_id Int
  item    ExpenseItemMaster @relation(fields: [item_id], references: [id])

  // Fact Table fields for easy reporting
  category_id Int
  category    BudgetCategory @relation(fields: [category_id], references: [id])

  fund_id Int
  fund    FundMaster @relation(fields: [fund_id], references: [id])

  amount_gov    Decimal  @default(0) @db.Decimal(15, 2)
  amount_income Decimal  @default(0) @db.Decimal(15, 2)
  details       Json?
  updated_at    DateTime @updatedAt

  @@index([academic_year])
  @@index([category_id])
  @@index([fund_id])
  @@map("budget_records")
}