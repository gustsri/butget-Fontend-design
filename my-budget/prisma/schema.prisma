generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. Enums (ตัวเลือกต่างๆ)
// ==========================================
enum DegreeLevel {
  bachelor
  bachelor_master
  master
  phd
}

enum ProgramType {
  normal
  international
}

enum PlanType {
  plan
  actual
}

enum BudgetStatus {
  draft
  submitted
  approved
  rejected
}

// ==========================================
// 2. ส่วนจัดการงบประมาณรายรับ (Revenue)
// ==========================================

// ตารางปีงบประมาณ (Header)
model RevenueBudget {
  revenue_budget_id Int          @id @default(autoincrement())
  budget_year       Int          @unique
  
  total_amount      Decimal      @default(0) @db.Decimal(15, 2)
  net_amount        Decimal      @default(0) @db.Decimal(15, 2)
  
  status            BudgetStatus @default(draft)
  version           Int          @default(1)
  
  is_active         Boolean      @default(true)
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt

  // Relations
  sections          RevenueSection[] 
  enrollment_info   EnrollmentInformation[]

  @@map("revenue_budgets")
}

// ตารางหมวดหมู่ (Section)
model RevenueSection {
  section_id        Int      @id @default(autoincrement())
  revenue_budget_id Int
  
  section_name      String
  sort_order        Int

  // Relation
  budget            RevenueBudget @relation(fields: [revenue_budget_id], references: [revenue_budget_id], onDelete: Cascade)
  items             RevenueItem[] 

  @@map("revenue_sections")
}

// ตารางรายการย่อย (Item)
model RevenueItem {
  item_id           Int      @id @default(autoincrement())
  section_id        Int
  
  item_name         String
  amount            Decimal  @default(0) @db.Decimal(15, 2)
  
  sort_order        Int
  is_deduction      Boolean  @default(false)
  
  // Relation
  section           RevenueSection @relation(fields: [section_id], references: [section_id], onDelete: Cascade)

  @@map("revenue_items")
}

// ==========================================
// 3. ส่วนข้อมูลการศึกษา (Academic & Enrollment)
// ==========================================

model AcademicProgram {
  academic_program_id Int         @id @default(autoincrement())
  program_name        String      @db.VarChar(255)
  degree_level        DegreeLevel
  program_type        ProgramType
  tuition_per_semester Decimal    @default(0) @db.Decimal(12, 2)
  
  is_active           Boolean     @default(true)
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  // Relations
  EnrollmentInformation EnrollmentInformation[]

  @@map("academic_programs") 
}

model EnrollmentInformation {
  enrollment_id       Int      @id @default(autoincrement())
  
  academic_program_id Int
  revenue_budget_id   Int      
  
  academic_year       Int      
  semester            Int      
  
  plan_type           PlanType
  
  year1_count         Int      @default(0)
  year2_count         Int      @default(0)
  year3_count         Int      @default(0)
  year4_count         Int      @default(0)
  year5_count         Int      @default(0)
  year6_count         Int      @default(0)
  graduates           Int      @default(0) 

  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // Relations
  program             AcademicProgram @relation(fields: [academic_program_id], references: [academic_program_id])
  budget              RevenueBudget   @relation(fields: [revenue_budget_id], references: [revenue_budget_id])
  
  @@map("enrollment_information")
  @@unique([academic_program_id, revenue_budget_id, plan_type, academic_year, semester])
}
// prisma/schema.prisma

model StructureCode {
  id                  Int      @id @default(autoincrement()) // structure_code_id
  code                String?  @db.VarChar(20)               // structure_code (รหัส)
  name                String   @db.VarChar(255)              // structure_code_name (ชื่อรายการ)
  level               Int      // ระดับชั้น (Indentation)
  is_header           Boolean  @default(false)               // เป็นหัวข้อหรือไม่
  
  category  String?  @db.VarChar(50) // เช่น "EXPENSE_ESTIMATE", "INCOME", "GENERAL"

  // Self-relation (Parent-Child) เพื่อรองรับ Hierarchy
  parent_id           Int?
  parent              StructureCode?  @relation("StructureHierarchy", fields: [parent_id], references: [id])
  children            StructureCode[] @relation("StructureHierarchy")

  // Relation ไปยัง Transaction (งบประมาณแต่ละปี)
  expense_items       ExpenseItem[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("structure_codes")
}

model ExpenseBudget {
  id              Int       @id @default(autoincrement())
  academic_year   Int
  total_amount    Decimal   @db.Decimal(12, 2) @default(0)
  status          String    @default("DRAFT")
  
  items           ExpenseItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("expense_budgets")
}

model ExpenseItem {
  id              Int       @id @default(autoincrement())
  
  budget_id       Int
  budget          ExpenseBudget @relation(fields: [budget_id], references: [id], onDelete: Cascade)
  
  // Link กับ Master Data
  structure_id    Int
  structure       StructureCode @relation(fields: [structure_id], references: [id])

  // ยอดเงิน (บันทึกเฉพาะค่าเงินที่นี่)
  gov_amount      Decimal   @db.Decimal(12, 2) @default(0)
  income_amount   Decimal   @db.Decimal(12, 2) @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([budget_id, structure_id])
  @@map("expense_items")
}